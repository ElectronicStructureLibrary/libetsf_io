<?xml version="1.0" encoding="ISO-8859-1"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
                      "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html  xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<meta http-equiv="Content-Style-Type" content="text/css" />
<meta http-equiv="Content-type" content="text/html; charset=ISO-8859-1" />
<link rel="stylesheet" href="../robodoc.css" type="text/css" />
<title>./src/tutorials/read_a_file.f90</title>
<!-- Source: ./src/tutorials/read_a_file.f90 -->
<!-- Generated with ROBODoc Version 4.99.30 (Jun 25 2008) -->
</head>
<body>
<div id="logo">
<a name="robo_top_of_doc">ETSF_IO library - documentation pages</a>
</div> <!-- logo -->
<div id="navigation">
</div> <!-- navigation -->
<div id="content">
<h3>TABLE OF CONTENTS</h3>
<ul>
<li><a href="#robo131">read_a_file</a></li>
</ul>
<hr />
<a name="etsf5fio5ftutorials2fread5fa5ffile">
</a><a name="robo131"></a><h2>read_a_file</h2>

<p>[ <a href="#robo_top_of_doc">Top</a> ] [ <a href="./README_f90.html#robo119">etsf_io_tutorials</a> ] [ <a href="../robo_tuto_cat.html#robo_top_of_doc">Tutorials</a> ]</p>
<p class="item_name">NAME</p>
<p>  <strong>read_a_file</strong>
</p>
<p class="item_name">FUNCTION</p>
<p>  In this example, we will describe how to read some variables from a file.
  This is a basic tutorial where the common ETSF routines (low level and
  specification level) will be used. We will see how to handle errors.
</p>

<p>  This tutorial assume that the second tutorial (<a href="./read_write_sub_access_f90.html#robo132">read_write_sub_access</a>) has been
  done and has produced its file (<a href="./read_write_sub_access_f90.html#robo132">read_write_sub_access</a>.nc).
</p>

<p>  To compile this exemple, use (assuming default installation paths):
</p>
<pre>   ${F90} -I/opt/include/${F90} -o <strong>read_a_file</strong> <a href="#robo_top_of_doc">read_a_file.f90</a>
          -L/opt/lib -letsf_io -letsf_io_utils -L/usr/lib -lnetcdf
</pre>
<p></p>
<p class="item_name">SOURCE</p>
<pre class="source"><span class="keyword">program</span> <strong>read_a_file</strong>

  <span class="keyword">use</span> <a href="../low_level/etsf_io_low_level_f90.html#robo2">etsf_io_low_level</a>
  <span class="keyword">use</span> <a href="../group_level/etsf_io_f90.html#robo0">etsf_io</a>
  <span class="keyword">use</span> <a href="../utils/etsf_io_tools_f90.html#robo3">etsf_io_tools</a>

  <span class="keyword">integer</span> <span class="sign">:</span><span class="sign">:</span> i<span class="sign">,</span> j<span class="sign">,</span> k
  <span class="keyword">logical</span> <span class="sign">:</span><span class="sign">:</span> symmetry

  <span class="comment">! Variables related to ETSF reading</span>
  <span class="comment">! ---------------------------------</span>
  <span class="comment">! An id to access the read file.</span>
  <span class="keyword">integer</span>                 <span class="sign">:</span><span class="sign">:</span> ncid
  <span class="comment">! A flag for all <a href="../group_level/etsf_io_f90.html#robo0">etsf_io</a> routine to know if everything went right.</span>
  <span class="keyword">logical</span>                 <span class="sign">:</span><span class="sign">:</span> lstat
  <span class="comment">! The storage for the detailled error.</span>
  <span class="keyword">type</span><span class="sign">(</span><a href="../low_level/public_variables_f90.html#robo68">etsf_io_low_error</a><span class="sign">)</span> <span class="sign">:</span><span class="sign">:</span> error_data
  <span class="comment">! The ETSF_IO structure to store all relevant dimensions.</span>
  <span class="keyword">type</span><span class="sign">(</span><a href="../group_level/etsf_io_f90.html#robo10">etsf_dims</a><span class="sign">)</span>         <span class="sign">:</span><span class="sign">:</span> dims
  <span class="comment">! The ETSF_IO structure to store all the split definitions.</span>
  <span class="keyword">type</span><span class="sign">(</span><a href="../group_level/etsf_io_f90.html#robo124">etsf_split</a><span class="sign">)</span>        <span class="sign">:</span><span class="sign">:</span> split
  <span class="comment">! The ETSF_IO structure to store the basis set and the k points definitions.</span>
  <span class="keyword">type</span><span class="sign">(</span><a href="../group_level/etsf_io_f90.html#robo122">etsf_kpoints</a><span class="sign">)</span>      <span class="sign">:</span><span class="sign">:</span> kpoints
  <span class="keyword">type</span><span class="sign">(</span><a href="../group_level/etsf_io_f90.html#robo8">etsf_basisdata</a><span class="sign">)</span>    <span class="sign">:</span><span class="sign">:</span> basisdata
  <span class="keyword">type</span><span class="sign">(</span><a href="../group_level/etsf_io_f90.html#robo123">etsf_main</a><span class="sign">)</span>         <span class="sign">:</span><span class="sign">:</span> main

  <span class="comment">! Variables independent from ETSF</span>
  <span class="comment">! -------------------------------</span>
  <span class="comment">! This array will store the wavefunctions.</span>
  <span class="keyword">double</span> <span class="keyword">precision</span><span class="sign">,</span> <span class="keyword">allocatable</span><span class="sign">,</span> target <span class="sign">:</span><span class="sign">:</span> pw_coeff<span class="sign">(</span><span class="sign">:</span><span class="sign">,</span> <span class="sign">:</span><span class="sign">,</span> <span class="sign">:</span><span class="sign">,</span> <span class="sign">:</span><span class="sign">)</span>
  <span class="comment">! Variables that will be used in the basisdata group.</span>
  <span class="keyword">integer</span><span class="sign">,</span> <span class="keyword">allocatable</span><span class="sign">,</span> target          <span class="sign">:</span><span class="sign">:</span> number_of_coefficients<span class="sign">(</span><span class="sign">:</span><span class="sign">)</span>
  <span class="keyword">integer</span><span class="sign">,</span> <span class="keyword">allocatable</span><span class="sign">,</span> target          <span class="sign">:</span><span class="sign">:</span> red_coord_pw<span class="sign">(</span><span class="sign">:</span><span class="sign">,</span> <span class="sign">:</span><span class="sign">,</span> <span class="sign">:</span><span class="sign">)</span>
  <span class="comment">! Variables that will be used in the kpoints group.</span>
  <span class="keyword">double</span> <span class="keyword">precision</span><span class="sign">,</span> <span class="keyword">allocatable</span><span class="sign">,</span> target <span class="sign">:</span><span class="sign">:</span> red_coord_kpt<span class="sign">(</span><span class="sign">:</span><span class="sign">,</span> <span class="sign">:</span><span class="sign">)</span>
  <span class="keyword">double</span> <span class="keyword">precision</span><span class="sign">,</span> <span class="keyword">allocatable</span><span class="sign">,</span> target <span class="sign">:</span><span class="sign">:</span> kpoint_weights<span class="sign">(</span><span class="sign">:</span><span class="sign">)</span>
  <span class="comment">! Variable to store the definition of the basis set</span>
  <span class="keyword">character</span><span class="sign">(</span><span class="keyword">len</span> <span class="sign">=</span> etsf_charlen<span class="sign">)</span><span class="sign">,</span> target <span class="sign">:</span><span class="sign">:</span> basis
</pre>
<p class="item_name">NOTES</p>
<p>  The file is simply open using a low level routine. We simply want to read
  its content so we specify it in the routine we use.
</p>

<p>  By default, this routine will check that the header is a valid ETSF one, with the
  right Convention global attribute, as for the file_format global attribute.
</p>

<p>  We also check that the file is at least version 2.1 using the optional argument
  @version_min.
</p>
<p class="item_name">SOURCE</p>
<pre class="source">  <span class="keyword">call</span> <a href="../low_level/read_routines_f90.html#robo80">etsf_io_low_open_read</a><span class="sign">(</span>ncid<span class="sign">,</span> <span class="quote">"<a href="./read_write_sub_access_f90.html#robo132">read_write_sub_access</a>.nc"</span><span class="sign">,</span> lstat<span class="sign">,</span> <span class="sign">&amp;</span>
       <span class="sign">&amp;</span> error_data <span class="sign">=</span> error_data<span class="sign">,</span> version_min <span class="sign">=</span> 2<span class="sign">.</span>1<span class="sign">)</span>
  <span class="keyword">if</span> <span class="sign">(</span><span class="sign">.</span><span class="keyword">not</span><span class="sign">.</span> lstat<span class="sign">)</span> <span class="keyword">then</span>
     <span class="comment">! We use the default writing of the error to stderr.</span>
     <span class="keyword">call</span> <a href="../low_level/etsf_io_low_level_f90.html#robo70">etsf_io_low_error_handle</a><span class="sign">(</span>error_data<span class="sign">)</span>
     stop
  <span class="keyword">end</span> <span class="keyword">if</span>
</pre>
<p class="item_name">NOTES</p>
<p>  We consider that the file contains the wavefunction description in plane waves.
  We thus read the dimensions first to allocate the program arrays.
</p>
<p class="item_name">SOURCE</p>
<pre class="source">  <span class="keyword">call</span> <a href="../group_level/etsf_io_dims_get_f90.html#robo34">etsf_io_dims_get</a><span class="sign">(</span>ncid<span class="sign">,</span> dims<span class="sign">,</span> lstat<span class="sign">,</span> error_data<span class="sign">)</span>
  <span class="keyword">if</span> <span class="sign">(</span><span class="sign">.</span><span class="keyword">not</span><span class="sign">.</span> lstat<span class="sign">)</span> <span class="keyword">then</span>
     <span class="keyword">call</span> <a href="../low_level/etsf_io_low_level_f90.html#robo70">etsf_io_low_error_handle</a><span class="sign">(</span>error_data<span class="sign">)</span>
     stop
  <span class="keyword">end</span> <span class="keyword">if</span>
</pre>
<p class="item_name">NOTES</p>
<p>  The coefficients of the wavefunctions may be splitted. We know this, thanks to
  the my_&lt;something&gt; attributes of the dims structure we have just read.
</p>

<p>  In the case of splitting, we allocate a new structure called split with
  <a href="../group_level/etsf_io_split_allocate_f90.html#robo108">etsf_io_split_allocate</a>() and we read its contents with <a href="../group_level/etsf_io_split_get_f90.html#robo112">etsf_io_split_get</a>(). In
  the case where the file contains no split informations, then all these routines
  will do nothing.
</p>

<p>  A split that has been allocated must be freed after use with <a href="../group_level/etsf_io_split_free_f90.html#robo111">etsf_io_split_free</a>().
  Since the split informations are not relevent for the purpose of this tutorial
  we will free it just after having output some informations to the user.
</p>
<p class="item_name">SOURCE</p>
<pre class="source">  <span class="keyword">call</span> <a href="../group_level/etsf_io_split_allocate_f90.html#robo108">etsf_io_split_allocate</a><span class="sign">(</span>split<span class="sign">,</span> dims<span class="sign">)</span>
  <span class="keyword">call</span> <a href="../group_level/etsf_io_split_get_f90.html#robo112">etsf_io_split_get</a><span class="sign">(</span>ncid<span class="sign">,</span> split<span class="sign">,</span> lstat<span class="sign">,</span> error_data<span class="sign">)</span>
  <span class="keyword">if</span> <span class="sign">(</span><span class="sign">.</span><span class="keyword">not</span><span class="sign">.</span> lstat<span class="sign">)</span> <span class="keyword">then</span>
     <span class="keyword">call</span> <a href="../low_level/etsf_io_low_level_f90.html#robo70">etsf_io_low_error_handle</a><span class="sign">(</span>error_data<span class="sign">)</span>
     stop
  <span class="keyword">end</span> <span class="keyword">if</span>
  <span class="comment">! We warn the user.</span>
  <span class="keyword">write</span><span class="comment">(*,"(A,L1)") " Split over kpoints     : ", associated(split%my_kpoints)
  write(*,"(A,L1)") " Split over spins       : ", associated(split%my_spins)
  write(*,"(A,L1)") " Split over states      : ", associated(split%my_states)
  write(*,"(A,L1)") " Split over coefficients: ", associated(split%my_coefficients)
  ! We don't use the split informations further so we free them.
  call <a href="../group_level/etsf_io_split_free_f90.html#robo111">etsf_io_split_free</a>(split)
</pre>
<p class="item_name">NOTES</p>
<p>  Before reading the coefficients of wavefunctions, we will get the definition
  of the basis set and the kpoints definitions.
</p>

<p>  This is done using the structure of types <a href="../group_level/etsf_io_f90.html#robo122">etsf_kpoints</a> and <a href="../group_level/etsf_io_f90.html#robo8">etsf_basisdata</a> and
  the <a href="../group_level/etsf_io_f90.html#robo0">etsf_io</a> level <a href="../group_level/etsf_io_kpoints_get_f90.html#robo58">etsf_io_kpoints_get</a>() and <a href="../group_level/etsf_io_basisdata_get_f90.html#robo19">etsf_io_basisdata_get</a>(). As for the
  put routines, we associate the variables we want to read and only them.
</p>

<p>  Then we read the coefficients as all other variables, using the main group.
</p>
<p class="item_name">SOURCE</p>
<pre class="source">  <span class="comment">! The main program allocate memory for storage of the basis set.</span>
  <span class="keyword">allocate</span><span class="sign">(</span>pw_coeff<span class="sign">(</span>dims<span class="sign">%</span>real_or_complex_coefficients<span class="sign">,</span> <span class="sign">&amp;</span>
       <span class="sign">&amp;</span> dims<span class="sign">%</span>max_number_of_coefficients<span class="sign">,</span> <span class="sign">&amp;</span>
       <span class="sign">&amp;</span> dims<span class="sign">%</span>max_number_of_states<span class="sign">,</span> <span class="sign">&amp;</span>
       <span class="sign">&amp;</span> dims<span class="sign">%</span>number_of_spins <span class="sign">*</span> <span class="sign">&amp;</span>
       <span class="sign">&amp;</span> dims<span class="sign">%</span>number_of_kpoints <span class="sign">*</span> <span class="sign">&amp;</span>
       <span class="sign">&amp;</span> dims<span class="sign">%</span>number_of_spinor_components<span class="sign">)</span><span class="sign">)</span>
  <span class="keyword">allocate</span><span class="sign">(</span>number_of_coefficients<span class="sign">(</span>dims<span class="sign">%</span>number_of_kpoints<span class="sign">)</span><span class="sign">)</span>
  <span class="keyword">allocate</span><span class="sign">(</span>red_coord_pw<span class="sign">(</span>dims<span class="sign">%</span>number_of_reduced_dimensions<span class="sign">,</span> <span class="sign">&amp;</span>
       <span class="sign">&amp;</span> dims<span class="sign">%</span>max_number_of_coefficients<span class="sign">,</span> dims<span class="sign">%</span>number_of_kpoints<span class="sign">)</span><span class="sign">)</span>
  <span class="keyword">allocate</span><span class="sign">(</span>red_coord_kpt<span class="sign">(</span>dims<span class="sign">%</span>number_of_reduced_dimensions<span class="sign">,</span> dims<span class="sign">%</span>number_of_kpoints<span class="sign">)</span><span class="sign">)</span>
  <span class="keyword">allocate</span><span class="sign">(</span>kpoint_weights<span class="sign">(</span>dims<span class="sign">%</span>number_of_kpoints<span class="sign">)</span><span class="sign">)</span>

  <span class="comment">! We set the associations.</span>
  kpoints<span class="sign">%</span>reduced_coordinates_of_kpoints <span class="sign">=</span><span class="sign">&gt;</span> red_coord_kpt
  kpoints<span class="sign">%</span>kpoint_weights <span class="sign">=</span><span class="sign">&gt;</span> kpoint_weights
  basisdata<span class="sign">%</span>basis_set <span class="sign">=</span><span class="sign">&gt;</span> basis
  basisdata<span class="sign">%</span>reduced_coordinates_of_plane_waves<span class="sign">%</span>data3D <span class="sign">=</span><span class="sign">&gt;</span> red_coord_pw
  basisdata<span class="sign">%</span>number_of_coefficients <span class="sign">=</span><span class="sign">&gt;</span> number_of_coefficients
  main<span class="sign">%</span>coefficients_of_wavefunctions<span class="sign">%</span>data4D <span class="sign">=</span><span class="sign">&gt;</span> pw_coeff

  <span class="comment">! We call the get routines.</span>
  <span class="keyword">call</span> <a href="../group_level/etsf_io_kpoints_get_f90.html#robo58">etsf_io_kpoints_get</a><span class="sign">(</span>ncid<span class="sign">,</span> kpoints<span class="sign">,</span> lstat<span class="sign">,</span> error_data<span class="sign">)</span>
  <span class="keyword">if</span> <span class="sign">(</span><span class="sign">.</span><span class="keyword">not</span><span class="sign">.</span> lstat<span class="sign">)</span> <span class="keyword">then</span>
     <span class="keyword">call</span> <a href="../low_level/etsf_io_low_level_f90.html#robo70">etsf_io_low_error_handle</a><span class="sign">(</span>error_data<span class="sign">)</span>
     stop
  <span class="keyword">end</span> <span class="keyword">if</span>
  <span class="keyword">call</span> <a href="../group_level/etsf_io_basisdata_get_f90.html#robo19">etsf_io_basisdata_get</a><span class="sign">(</span>ncid<span class="sign">,</span> basisdata<span class="sign">,</span> lstat<span class="sign">,</span> error_data<span class="sign">)</span>
  <span class="keyword">if</span> <span class="sign">(</span><span class="sign">.</span><span class="keyword">not</span><span class="sign">.</span> lstat<span class="sign">)</span> <span class="keyword">then</span>
     <span class="keyword">call</span> <a href="../low_level/etsf_io_low_level_f90.html#robo70">etsf_io_low_error_handle</a><span class="sign">(</span>error_data<span class="sign">)</span>
     stop
  <span class="keyword">end</span> <span class="keyword">if</span>
  <span class="keyword">call</span> <a href="../low_level/etsf_io_low_level_f90.html#robo133">strip</a><span class="sign">(</span>basis<span class="sign">)</span>
  <span class="keyword">call</span> <a href="../group_level/etsf_io_main_get_f90.html#robo102">etsf_io_main_get</a><span class="sign">(</span>ncid<span class="sign">,</span> main<span class="sign">,</span> lstat<span class="sign">,</span> error_data<span class="sign">)</span>
  <span class="keyword">if</span> <span class="sign">(</span><span class="sign">.</span><span class="keyword">not</span><span class="sign">.</span> lstat<span class="sign">)</span> <span class="keyword">then</span>
     <span class="keyword">call</span> <a href="../low_level/etsf_io_low_level_f90.html#robo70">etsf_io_low_error_handle</a><span class="sign">(</span>error_data<span class="sign">)</span>
     stop
  <span class="keyword">end</span> <span class="keyword">if</span>
</pre>
<p class="item_name">NOTES</p>
<p>  We poll the file using an <a href="../utils/etsf_io_tools_f90.html#robo3">etsf_io_tools</a> routine to know if the number of
  coefficients have been reduced using the time reversal symmetry at Gamma.
</p>
<p class="item_name">SOURCE</p>
<pre class="source">  <span class="keyword">call</span> <a href="../utils/etsf_io_tools_f90.html#robo117">etsf_io_tools_get_time_reversal_symmetry</a><span class="sign">(</span>ncid<span class="sign">,</span> symmetry<span class="sign">,</span> <span class="sign">&amp;</span>
       <span class="sign">&amp;</span> lstat<span class="sign">,</span> error_data<span class="sign">)</span>
  <span class="keyword">if</span> <span class="sign">(</span><span class="sign">.</span><span class="keyword">not</span><span class="sign">.</span> lstat<span class="sign">)</span> <span class="keyword">then</span>
     <span class="keyword">call</span> <a href="../low_level/etsf_io_low_level_f90.html#robo70">etsf_io_low_error_handle</a><span class="sign">(</span>error_data<span class="sign">)</span>
     stop
  <span class="keyword">end</span> <span class="keyword">if</span>
</pre>
<p class="item_name">NOTES</p>
<p>  The following is just output on screen.
</p>
<p class="item_name">SOURCE</p>
<pre class="source">  <span class="comment">! We output the informations to the user.</span>
  <span class="keyword">write</span><span class="comment">(*,*)</span>
  <span class="keyword">write</span><span class="comment">(*,"(A,I0)") " Number of k points     : ", dims%number_of_kpoints
  write(*,*)</span> <span class="quote">"k point weights        : "</span><span class="sign">,</span> kpoints<span class="sign">%</span>kpoint_weights
  <span class="keyword">write</span><span class="comment">(*,"(A)") " k point coordinates    : "
  do i = 1, dims%number_of_kpoints, 1
     write(*, "(3F10.5)") red_coord_kpt(:, i)
  end do
  write(*,*)</span>
  <span class="keyword">write</span><span class="comment">(*,"(A,A)") " Used basis set         : ", trim(basis)
  write(*,"(A,L1)") " Time reversal symmetry : ", symmetry
  write(*,"(A,I0)") " Max number of coeffs   : ", dims%max_number_of_coefficients
  do i = 1, dims%number_of_kpoints, 1
     write(*,*)</span>
     <span class="keyword">write</span><span class="comment">(*,"(A,I0)") " Informations at k point: ", i
     write(*,"(A,I0)") " Number of coefficients : ", number_of_coefficients(i)
     write(*,"(A)") " Coordinates of g vector: "
     do j = 1, min(dims%max_number_of_coefficients, 5), 1
        write(*, "(3I5,A,I2,A)") red_coord_pw(:, j, i), " (g vector ", j, ")"
     end do
     if (j &lt; dims%max_number_of_coefficients) then
        write(*,*)</span> <span class="quote">"   ..."</span>
     <span class="keyword">end</span> <span class="keyword">if</span>
     <span class="keyword">write</span><span class="comment">(*,"(A)") " Coeffs of wavefunctions: "
     do k = 1, dims%max_number_of_states, 1
        write(*,"(A,I0)") " Band number            : ", k
        do j = 1, min(dims%max_number_of_coefficients, 5), 1
           write(*, "(2F12.5,A,I2,A)") pw_coeff(:, j, k, i), " (g vector ", j, ")"
        end do
        if (j &lt; dims%max_number_of_coefficients) then
           write(*,*)</span> <span class="quote">"   ..."</span>
        <span class="keyword">end</span> <span class="keyword">if</span>
     <span class="keyword">end</span> <span class="keyword">do</span>
  <span class="keyword">end</span> <span class="keyword">do</span>

  <span class="comment">! We deallocate everything</span>
  <span class="keyword">deallocate</span><span class="sign">(</span>pw_coeff<span class="sign">)</span>
  <span class="keyword">deallocate</span><span class="sign">(</span>number_of_coefficients<span class="sign">)</span>
  <span class="keyword">deallocate</span><span class="sign">(</span>red_coord_pw<span class="sign">)</span>
  <span class="keyword">deallocate</span><span class="sign">(</span>kpoint_weights<span class="sign">)</span>
  <span class="keyword">deallocate</span><span class="sign">(</span>red_coord_kpt<span class="sign">)</span>

<span class="keyword">end</span> <span class="keyword">program</span> <strong>read_a_file</strong>
</pre>

</div> <!-- content -->
<div id="footer">
<p>Generated from ./src/tutorials/read_a_file.f90 with <a href="http://www.xs4all.nl/~rfsber/Robo/robodoc.html">ROBODoc</a> V4.99.30 on Mon Mar 29 2010 11:04:45
</p>
</div> <!-- footer -->
</body>
</html>
