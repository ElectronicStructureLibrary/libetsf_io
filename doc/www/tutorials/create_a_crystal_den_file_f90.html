<?xml version="1.0" encoding="ISO-8859-1"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
                      "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html  xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<meta http-equiv="Content-Style-Type" content="text/css" />
<meta http-equiv="Content-type" content="text/html; charset=ISO-8859-1" />
<link rel="stylesheet" href="../robodoc.css" type="text/css" />
<title>./src/tutorials/create_a_crystal_den_file.f90</title>
<!-- Source: ./src/tutorials/create_a_crystal_den_file.f90 -->
<!-- Generated with ROBODoc Version 4.99.30 (Jun 25 2008) -->
</head>
<body>
<div id="logo">
<a name="robo_top_of_doc">ETSF_IO library - documentation pages</a>
</div> <!-- logo -->
<div id="navigation">
</div> <!-- navigation -->
<div id="content">
<h3>TABLE OF CONTENTS</h3>
<ul>
<li><a href="#robo5">create_a_crystal_den_file</a></li>
</ul>
<hr />
<a name="etsf5fio5ftutorials2fcreate5fa5fcrystal5fden5ffile">
</a><a name="robo5"></a><h2>create_a_crystal_den_file</h2>

<p>[ <a href="#robo_top_of_doc">Top</a> ] [ <a href="./README_f90.html#robo119">etsf_io_tutorials</a> ] [ <a href="../robo_tuto_cat.html#robo_top_of_doc">Tutorials</a> ]</p>
<p class="item_name">NAME</p>
<p>  <strong>create_a_crystal_den_file</strong>
</p>
<p class="item_name">FUNCTION</p>
<p>  In this example, we will describe how to use the <a href="../group_level/etsf_io_data_init_f90.html#robo26">etsf_io_data_init</a>() routine.
  This routine creates a file, conforming to the ETSF specifications, with
  several uninitialised variables in it. Then we will see how to write values
  into this file, using <a href="../group_level/etsf_io_data_write_f90.html#robo28">etsf_io_data_write</a>().
</p>

<p>  To compile this exemple, use (assuming default installation paths):
</p>
<pre>   ${F90} -I/opt/include/${F90} -o <strong>create_a_crystal_den_file</strong> <a href="#robo_top_of_doc">create_a_crystal_den_file.f90</a>
          -L/opt/lib -letsf_io -L/usr/lib -lnetcdf
</pre>
<p></p>
<p class="item_name">SOURCE</p>
<pre class="source"><span class="keyword">program</span> <strong>create_a_crystal_den_file</strong>

  <span class="keyword">use</span> <a href="../group_level/etsf_io_f90.html#robo0">etsf_io</a>

  <span class="keyword">integer</span> <span class="sign">:</span><span class="sign">:</span> i
</pre>
<p class="item_name">NOTES</p>
<p>  All routines from the group level requires two output arguments:
</p>
<pre>   * lstat which is a logical. When .false. something goes wrong in
     the routine and the action is aborted. No actions are atomic, which
     means that if lstat is .false., the status of the NetCDF file (what
     have been done) is not guarantee.
   * error_data which a of type #<a href="../low_level/public_variables_f90.html#robo68">etsf_io_low_error</a>. It contains many informations
     about the error if lstat is .false.. One can use <a href="../low_level/etsf_io_low_level_f90.html#robo73">etsf_io_low_error_to_str</a>
     to get a character(len = 1024) describing the error, or one can implement
     one itself since the type is public and documented.
</pre>
<p></p>
<p class="item_name">SOURCE</p>
<pre class="source">  <span class="keyword">logical</span>                 <span class="sign">:</span><span class="sign">:</span> lstat
  <span class="keyword">type</span><span class="sign">(</span><a href="../low_level/public_variables_f90.html#robo68">etsf_io_low_error</a><span class="sign">)</span> <span class="sign">:</span><span class="sign">:</span> error_data
</pre>
<p class="item_name">NOTES</p>
<p>  To create a NetCDF, we need to give at creation time all the dimensions that
  define the variables. The file will then be allocated on disk and may be write
  with values later. All dimensions declared in the ETSF specifications are stored
  in a type called <a href="../group_level/etsf_io_f90.html#robo10">etsf_dims</a>. Some of these dimensions are fixed by the specifications
  such as character_string_length and will be set by the <a href="../group_level/etsf_io_data_init_f90.html#robo26">etsf_io_data_init</a>() routine itself.
  Other values are free to be chosen.
</p>
<p class="item_name">SOURCE</p>
<pre class="source">  <span class="keyword">type</span><span class="sign">(</span><a href="../group_level/etsf_io_f90.html#robo10">etsf_dims</a><span class="sign">)</span>         <span class="sign">:</span><span class="sign">:</span> dims
</pre>
<p class="item_name">NOTES</p>
<p>  To write values in one call into an already defined ETSF file, the type <a href="../group_level/etsf_io_f90.html#robo13">etsf_groups</a>
  is used as a container for several groups. Here our container will have associated
  pointers on an <a href="../group_level/etsf_io_f90.html#robo12">etsf_geometry</a> and an <a href="../group_level/etsf_io_f90.html#robo123">etsf_main</a>. So we declare them. All the structures
  used in this library are only containers and do not have the allocated memory. This
  is done to avoid memory duplication when using the library with a code with its own
  variables. So we also need some variables (in a real case, they are declared in
  the main program) to stored our density and geometric informations.
</p>
<p class="item_name">SOURCE</p>
<pre class="source">  <span class="comment">! Specific variables required by the library</span>
  <span class="keyword">type</span><span class="sign">(</span><a href="../group_level/etsf_io_f90.html#robo14">etsf_groups_flags</a><span class="sign">)</span>     <span class="sign">:</span><span class="sign">:</span> flags
  <span class="keyword">type</span><span class="sign">(</span><a href="../group_level/etsf_io_f90.html#robo13">etsf_groups</a><span class="sign">)</span>           <span class="sign">:</span><span class="sign">:</span> groups
  <span class="keyword">type</span><span class="sign">(</span><a href="../group_level/etsf_io_f90.html#robo12">etsf_geometry</a><span class="sign">)</span><span class="sign">,</span> target <span class="sign">:</span><span class="sign">:</span> geometry
  <span class="keyword">type</span><span class="sign">(</span><a href="../group_level/etsf_io_f90.html#robo123">etsf_main</a><span class="sign">)</span><span class="sign">,</span> target     <span class="sign">:</span><span class="sign">:</span> main
  <span class="comment">! Variables that are declared in the main program in a real case</span>
  <span class="keyword">double</span> <span class="keyword">precision</span><span class="sign">,</span> <span class="keyword">allocatable</span><span class="sign">,</span> target <span class="sign">:</span><span class="sign">:</span> density<span class="sign">(</span><span class="sign">:</span><span class="sign">)</span>
  <span class="keyword">integer</span><span class="sign">,</span> target                       <span class="sign">:</span><span class="sign">:</span> space_group
  <span class="keyword">double</span> <span class="keyword">precision</span><span class="sign">,</span> target              <span class="sign">:</span><span class="sign">:</span> primitive_vector<span class="sign">(</span>3<span class="sign">,</span> 3<span class="sign">)</span>
  <span class="keyword">double</span> <span class="keyword">precision</span><span class="sign">,</span> <span class="keyword">allocatable</span><span class="sign">,</span> target <span class="sign">:</span><span class="sign">:</span> reduced_atom_positions<span class="sign">(</span><span class="sign">:</span><span class="sign">,</span><span class="sign">:</span><span class="sign">)</span>
  <span class="keyword">integer</span><span class="sign">,</span> <span class="keyword">allocatable</span><span class="sign">,</span> target          <span class="sign">:</span><span class="sign">:</span> atom_species<span class="sign">(</span><span class="sign">:</span><span class="sign">)</span>
  <span class="keyword">character</span><span class="sign">(</span><span class="keyword">len</span><span class="sign">=</span>2<span class="sign">)</span><span class="sign">,</span> <span class="keyword">allocatable</span><span class="sign">,</span> target <span class="sign">:</span><span class="sign">:</span> chemical_symbols<span class="sign">(</span><span class="sign">:</span><span class="sign">)</span>
  <span class="keyword">integer</span><span class="sign">,</span> <span class="keyword">allocatable</span><span class="sign">,</span> target          <span class="sign">:</span><span class="sign">:</span> reduced_symmetry_matrices<span class="sign">(</span><span class="sign">:</span><span class="sign">,</span><span class="sign">:</span><span class="sign">,</span><span class="sign">:</span><span class="sign">)</span>
  <span class="keyword">double</span> <span class="keyword">precision</span><span class="sign">,</span> <span class="keyword">allocatable</span><span class="sign">,</span> target <span class="sign">:</span><span class="sign">:</span> reduced_symmetry_translations<span class="sign">(</span><span class="sign">:</span><span class="sign">,</span><span class="sign">:</span><span class="sign">)</span>
</pre>
<p class="item_name">NOTES</p>
<p>  We will create for example a file for the density
  of the silane molecule, without spin nor spin-orbit, 1 k point.
  We imagine that the molecule no symmetry except identity.
</p>
<p class="item_name">SOURCE</p>
<pre class="source">  dims<span class="sign">%</span>max_number_of_coefficients <span class="sign">=</span> 1400
  dims<span class="sign">%</span>max_number_of_states <span class="sign">=</span> 6
  dims<span class="sign">%</span>number_of_atoms <span class="sign">=</span> 5
  dims<span class="sign">%</span>number_of_atom_species <span class="sign">=</span> 2
  dims<span class="sign">%</span>number_of_components <span class="sign">=</span> 1
  dims<span class="sign">%</span>number_of_grid_points_vector1 <span class="sign">=</span> 36
  dims<span class="sign">%</span>number_of_grid_points_vector2 <span class="sign">=</span> 36
  dims<span class="sign">%</span>number_of_grid_points_vector3 <span class="sign">=</span> 36
  dims<span class="sign">%</span>number_of_kpoints <span class="sign">=</span> 1
  dims<span class="sign">%</span>number_of_spinor_components <span class="sign">=</span> 1
  dims<span class="sign">%</span>number_of_spins <span class="sign">=</span> 1
  dims<span class="sign">%</span>number_of_symmetry_operations <span class="sign">=</span> 1
</pre>
<p class="item_name">NOTES</p>
<p>  Now that dimensions have been stored in the appropriated structure, we can call the
  <a href="../group_level/etsf_io_data_init_f90.html#robo26">etsf_io_data_init</a>() routine itself. The 'groups' argument is very important
  It will tell which variables will we allocated
  on disk. All variables are gathered by groups and one can choose one or several
  groups to be defined. To do it, use the flags from #<a href="../group_level/etsf_io_f90.html#robo127">FLAGS_VARIABLES</a>,
  in a summation for each group in the <a href="../group_level/etsf_io_f90.html#robo14">etsf_groups_flags</a> structure. By default
  no group will be defined, to add the geometry group, we will use the value
  etsf_geometry_all (from #<a href="../group_level/etsf_io_f90.html#robo127">FLAGS_VARIABLES</a>) ; and to add the density variable (from
  the main group), and only this one, we will use etsf_main_denisty.
</p>

<p>  Other arguments of the routine are quite easy to understand. The optional k_dependent
  argument is here to handle the case of reduced_coordinates_of_plane_waves which
  shape depends on the value of this attribute. If k_dependent is given .false. (default
  is .true.), then all variables with this attribute will be labelled "no" and the
  variable reduced_coordinates_of_plane_waves will be a two dimensional array.
</p>
<p class="item_name">SOURCE</p>
<pre class="source">  flags<span class="sign">%</span>geometry <span class="sign">=</span> etsf_geometry_all
  flags<span class="sign">%</span>main     <span class="sign">=</span> etsf_main_density
  <span class="keyword">call</span> <a href="../group_level/etsf_io_data_init_f90.html#robo26">etsf_io_data_init</a><span class="sign">(</span><span class="quote">"<strong>create_a_crystal_den_file</strong>.nc"</span><span class="sign">,</span> flags<span class="sign">,</span> dims<span class="sign">,</span> <span class="sign">&amp;</span>
                       <span class="sign">&amp;</span> <span class="quote">"Tutorial ETSF_IO, create a density file"</span><span class="sign">,</span> <span class="sign">&amp;</span>
                       <span class="sign">&amp;</span> <span class="quote">"Created by the tutorial example of the library"</span><span class="sign">,</span> <span class="sign">&amp;</span>
                       <span class="sign">&amp;</span> lstat<span class="sign">,</span> error_data<span class="sign">)</span>
</pre>
<p class="item_name">NOTES</p>
<p>  The required variables for a density file are in <a href="../group_level/etsf_io_f90.html#robo12">etsf_geometry</a> and
  in <a href="../group_level/etsf_io_f90.html#robo123">etsf_main</a>, that's why the groups argument is the sum of the two flags.
</p>

<p>  We can now, handle the error, if one occured. The method <a href="../low_level/etsf_io_low_level_f90.html#robo70">etsf_io_low_error_handle</a>()
  is used to print the contains of an error type on the standrard output. If one is
  interested on printing the error on something different than the standard output,
  one should convert the error into a character(len = 1024) with <a href="../low_level/etsf_io_low_level_f90.html#robo73">etsf_io_low_error_to_str</a>()
  before.
</p>
<p class="item_name">SOURCE</p>
<pre class="source">  <span class="keyword">if</span> <span class="sign">(</span><span class="sign">.</span><span class="keyword">not</span><span class="sign">.</span> lstat<span class="sign">)</span> <span class="keyword">then</span>
    <span class="keyword">call</span> <a href="../low_level/etsf_io_low_level_f90.html#robo70">etsf_io_low_error_handle</a><span class="sign">(</span>error_data<span class="sign">)</span>
    stop
  <span class="keyword">end</span> <span class="keyword">if</span>
</pre>
<p class="item_name">NOTES</p>
<p>  At this time of the example, the disk space to store the density and the geometric
  informations has been reserved. In a real case, we let the main program computing
  the density and setting up the geometric informations.
</p>
<p class="item_name">SOURCE</p>
<pre class="source">  <span class="comment">! The main program allocate memory for its computation.</span>
  <span class="keyword">allocate</span><span class="sign">(</span>density<span class="sign">(</span>36 <span class="sign">*</span> 36 <span class="sign">*</span> 36<span class="sign">)</span><span class="sign">)</span>
  <span class="keyword">allocate</span><span class="sign">(</span>reduced_atom_positions<span class="sign">(</span>3<span class="sign">,</span>5<span class="sign">)</span><span class="sign">)</span>
  <span class="keyword">allocate</span><span class="sign">(</span>atom_species<span class="sign">(</span>5<span class="sign">)</span><span class="sign">)</span>
  <span class="keyword">allocate</span><span class="sign">(</span>chemical_symbols<span class="sign">(</span>2<span class="sign">)</span><span class="sign">)</span>
  <span class="keyword">allocate</span><span class="sign">(</span>reduced_symmetry_matrices<span class="sign">(</span>3<span class="sign">,</span> 3<span class="sign">,</span> 1<span class="sign">)</span><span class="sign">)</span>
  <span class="keyword">allocate</span><span class="sign">(</span>reduced_symmetry_translations<span class="sign">(</span>3<span class="sign">,</span> 1<span class="sign">)</span><span class="sign">)</span>
  
  <span class="comment">! The main program compute all symmetries and set up the positions...</span>
  space_group <span class="sign">=</span> 1
  primitive_vector <span class="sign">=</span> reshape<span class="sign">(</span> <span class="sign">(</span><span class="sign">/</span> 10<span class="sign">,</span> 0<span class="sign">,</span> 0<span class="sign">,</span> 0<span class="sign">,</span> 10<span class="sign">,</span> 0<span class="sign">,</span> 0<span class="sign">,</span> 0<span class="sign">,</span> 10 <span class="sign">/</span><span class="sign">)</span><span class="sign">,</span> <span class="sign">(</span><span class="sign">/</span> 3<span class="sign">,</span> 3 <span class="sign">/</span><span class="sign">)</span><span class="sign">)</span>
  reduced_symmetry_matrices <span class="sign">=</span> reshape<span class="sign">(</span> <span class="sign">(</span><span class="sign">/</span> 1<span class="sign">,</span> 0<span class="sign">,</span> 0<span class="sign">,</span> 0<span class="sign">,</span> 1<span class="sign">,</span> 0<span class="sign">,</span> 0<span class="sign">,</span> 0<span class="sign">,</span> 1 <span class="sign">/</span><span class="sign">)</span><span class="sign">,</span> <span class="sign">(</span><span class="sign">/</span> 3<span class="sign">,</span> 3<span class="sign">,</span> 1 <span class="sign">/</span><span class="sign">)</span><span class="sign">)</span>
  reduced_symmetry_translations <span class="sign">=</span> reshape<span class="sign">(</span> <span class="sign">(</span><span class="sign">/</span> 0<span class="sign">,</span> 0<span class="sign">,</span> 0 <span class="sign">/</span><span class="sign">)</span><span class="sign">,</span> <span class="sign">(</span><span class="sign">/</span> 3<span class="sign">,</span> 1 <span class="sign">/</span><span class="sign">)</span><span class="sign">)</span>
  reduced_atom_positions <span class="sign">=</span> reshape<span class="sign">(</span> <span class="sign">(</span><span class="sign">/</span> 0<span class="sign">.</span>5d0<span class="sign">,</span> 0<span class="sign">.</span>5d0<span class="sign">,</span> 0<span class="sign">.</span>5d0<span class="sign">,</span> <span class="sign">&amp;</span>
                                     <span class="sign">&amp;</span> 0<span class="sign">.</span>6d0<span class="sign">,</span> 0<span class="sign">.</span>6d0<span class="sign">,</span> 0<span class="sign">.</span>6d0<span class="sign">,</span> <span class="sign">&amp;</span>
                                     <span class="sign">&amp;</span> 0<span class="sign">.</span>6d0<span class="sign">,</span> 0<span class="sign">.</span>4d0<span class="sign">,</span> 0<span class="sign">.</span>4d0<span class="sign">,</span> <span class="sign">&amp;</span>
                                     <span class="sign">&amp;</span> 0<span class="sign">.</span>4d0<span class="sign">,</span> 0<span class="sign">.</span>4d0<span class="sign">,</span> 0<span class="sign">.</span>6d0<span class="sign">,</span> <span class="sign">&amp;</span>
                                     <span class="sign">&amp;</span> 0<span class="sign">.</span>4d0<span class="sign">,</span> 0<span class="sign">.</span>6d0<span class="sign">,</span> 0<span class="sign">.</span>4d0 <span class="sign">/</span><span class="sign">)</span><span class="sign">,</span> <span class="sign">(</span><span class="sign">/</span> 3<span class="sign">,</span> 5 <span class="sign">/</span><span class="sign">)</span><span class="sign">)</span>
  atom_species <span class="sign">=</span> <span class="sign">(</span><span class="sign">/</span> 2<span class="sign">,</span> 1<span class="sign">,</span> 1<span class="sign">,</span> 1<span class="sign">,</span> 1 <span class="sign">/</span><span class="sign">)</span>
  chemical_symbols <span class="sign">=</span> <span class="sign">(</span><span class="sign">/</span> <span class="quote">"H "</span><span class="sign">,</span> <span class="quote">"Si"</span> <span class="sign">/</span><span class="sign">)</span>

  <span class="comment">! We compute the density with a powerful algorithm.</span>
  density <span class="sign">=</span> <span class="sign">(</span><span class="sign">/</span> <span class="sign">(</span>0<span class="sign">.</span>d0 <span class="sign">+</span> i<span class="sign">,</span> i <span class="sign">=</span> 1<span class="sign">,</span> 36 <span class="sign">*</span> 36 <span class="sign">*</span> 36<span class="sign">)</span> <span class="sign">/</span><span class="sign">)</span>
</pre>
<p class="item_name">NOTES</p>
<p>  Before calling the <a href="../group_level/etsf_io_data_write_f90.html#robo28">etsf_io_data_write</a>() routine, we associate the pointers of our
  group types to the main program memory data. Only associated pointers will be written.
  All other defined variables will be let untouched. Some variable are defined with
  a type called <a href="../low_level/public_variables_f90.html#robo92">etsf_io_low_var_double</a> or <a href="../low_level/public_variables_f90.html#robo94">etsf_io_low_var_integer</a>. These variables
  are arrays which could have a different shape in the main program and in the
  specifications. For instance, our density is 1D only whereas in the specifications
  the density is 5D. So we use the attribute %data1D of the structure 
  <a href="../low_level/public_variables_f90.html#robo92">etsf_io_low_var_double</a> for the density. This will work because data in the main program
  memory has the same number of elements than the space defined in the ETSF file AND
  data are ordered in the same way (elements along X axis are varying quicker than
  along Y or Z).
</p>
<p class="item_name">SOURCE</p>
<pre class="source">  <span class="comment">! We associate the geometry</span>
  geometry<span class="sign">%</span>space_group <span class="sign">=</span><span class="sign">&gt;</span> space_group
  geometry<span class="sign">%</span>primitive_vectors <span class="sign">=</span><span class="sign">&gt;</span> primitive_vector
  geometry<span class="sign">%</span>reduced_symmetry_matrices <span class="sign">=</span><span class="sign">&gt;</span> reduced_symmetry_matrices
  geometry<span class="sign">%</span>reduced_symmetry_translations <span class="sign">=</span><span class="sign">&gt;</span> reduced_symmetry_translations
  geometry<span class="sign">%</span>atom_species <span class="sign">=</span><span class="sign">&gt;</span> atom_species
  geometry<span class="sign">%</span>reduced_atom_positions <span class="sign">=</span><span class="sign">&gt;</span> reduced_atom_positions
  geometry<span class="sign">%</span>chemical_symbols <span class="sign">=</span><span class="sign">&gt;</span> chemical_symbols
  <span class="comment">! We associate the main data</span>
  <span class="comment">! We don't want to dupplicate the density data even if ours is 1D</span>
  <span class="comment">! and ETSF is 5D, so we use the unformatted pointer in the <a href="../group_level/etsf_io_f90.html#robo123">etsf_main</a></span>
  <span class="comment">! structure.</span>
  main<span class="sign">%</span>density<span class="sign">%</span>data1D <span class="sign">=</span><span class="sign">&gt;</span> density
  <span class="comment">! We associate our two group in the container.</span>
  groups<span class="sign">%</span>geometry <span class="sign">=</span><span class="sign">&gt;</span> geometry
  groups<span class="sign">%</span>main <span class="sign">=</span><span class="sign">&gt;</span> main

  <span class="comment">! We write.</span>
  <span class="keyword">call</span> <a href="../group_level/etsf_io_data_write_f90.html#robo28">etsf_io_data_write</a><span class="sign">(</span><span class="quote">"<strong>create_a_crystal_den_file</strong>.nc"</span><span class="sign">,</span> <span class="sign">&amp;</span>
                        <span class="sign">&amp;</span> groups<span class="sign">,</span> lstat<span class="sign">,</span> error_data<span class="sign">)</span>
  <span class="comment">! We handle the error</span>
  <span class="keyword">if</span> <span class="sign">(</span><span class="sign">.</span><span class="keyword">not</span><span class="sign">.</span> lstat<span class="sign">)</span> <span class="keyword">then</span>
    <span class="keyword">call</span> <a href="../low_level/etsf_io_low_level_f90.html#robo70">etsf_io_low_error_handle</a><span class="sign">(</span>error_data<span class="sign">)</span>
    stop
  <span class="keyword">end</span> <span class="keyword">if</span>
  
  <span class="comment">! The main program will deallocate its own memory.</span>
  <span class="keyword">deallocate</span><span class="sign">(</span>density<span class="sign">)</span>
  <span class="keyword">deallocate</span><span class="sign">(</span>reduced_atom_positions<span class="sign">)</span>
  <span class="keyword">deallocate</span><span class="sign">(</span>atom_species<span class="sign">)</span>
  <span class="keyword">deallocate</span><span class="sign">(</span>chemical_symbols<span class="sign">)</span>
  <span class="keyword">deallocate</span><span class="sign">(</span>reduced_symmetry_matrices<span class="sign">)</span>
  <span class="keyword">deallocate</span><span class="sign">(</span>reduced_symmetry_translations<span class="sign">)</span>
<span class="keyword">end</span> <span class="keyword">program</span> <strong>create_a_crystal_den_file</strong>
</pre>

</div> <!-- content -->
<div id="footer">
<p>Generated from ./src/tutorials/create_a_crystal_den_file.f90 with <a href="http://www.xs4all.nl/~rfsber/Robo/robodoc.html">ROBODoc</a> V4.99.30 on Mon Mar 29 2010 11:04:46
</p>
</div> <!-- footer -->
</body>
</html>
