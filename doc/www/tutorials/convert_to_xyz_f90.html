<?xml version="1.0" encoding="ISO-8859-1"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
                      "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html  xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<meta http-equiv="Content-Style-Type" content="text/css" />
<meta http-equiv="Content-type" content="text/html; charset=ISO-8859-1" />
<link rel="stylesheet" href="../robodoc.css" type="text/css" />
<title>./src/tutorials/convert_to_xyz.f90</title>
<!-- Source: ./src/tutorials/convert_to_xyz.f90 -->
<!-- Generated with ROBODoc Version 4.99.30 (Jun 25 2008) -->
</head>
<body>
<div id="logo">
<a name="robo_top_of_doc">ETSF_IO library - documentation pages</a>
</div> <!-- logo -->
<div id="navigation">
</div> <!-- navigation -->
<div id="content">
<h3>TABLE OF CONTENTS</h3>
<ul>
<li><a href="#robo4">convert_to_xyz</a></li>
</ul>
<hr />
<a name="etsf5fio5ftutorials2fconvert5fto5fxyz">
</a><a name="robo4"></a><h2>convert_to_xyz</h2>

<p>[ <a href="#robo_top_of_doc">Top</a> ] [ <a href="./README_f90.html#robo119">etsf_io_tutorials</a> ] [ <a href="../robo_tuto_cat.html#robo_top_of_doc">Tutorials</a> ]</p>
<p class="item_name">NAME</p>
<p>  <strong>convert_to_xyz</strong>
</p>
<p class="item_name">FUNCTION</p>
<p>  In this example, we will describe how to use the high level routines from
  <a href="../utils/etsf_io_file_f90.html#robo1">etsf_io_file</a> and <a href="../utils/etsf_io_tools_f90.html#robo3">etsf_io_tools</a> (from library etsf_io_utils). Doing it, we will
  read a cristallographic file, check its validity and convert it to XYZ file,
  reading the coordinates of atoms and getting their names.
</p>

<p>  To compile this exemple, use (assuming default installation paths):
</p>
<pre>   ${F90} -I/opt/include/${F90} -o <strong>convert_to_xyz</strong> <a href="#robo_top_of_doc">convert_to_xyz.f90</a>
          -L/opt/lib -letsf_io_utils -letsf_io -L/usr/lib -lnetcdf
</pre>
<p></p>
<p class="item_name">SOURCE</p>
<pre class="source"><span class="keyword">program</span> <strong>convert_to_xyz</strong>

  <span class="keyword">use</span> <a href="../low_level/etsf_io_low_level_f90.html#robo2">etsf_io_low_level</a>
  <span class="keyword">use</span> <a href="../group_level/etsf_io_f90.html#robo0">etsf_io</a>
  <span class="keyword">use</span> <a href="../utils/etsf_io_file_f90.html#robo1">etsf_io_file</a>
  <span class="keyword">use</span> <a href="../utils/etsf_io_tools_f90.html#robo3">etsf_io_tools</a>

  <span class="keyword">implicit</span> <span class="keyword">none</span>

  <span class="keyword">integer</span> <span class="sign">:</span><span class="sign">:</span> iargc
  <span class="keyword">character</span><span class="sign">(</span><span class="keyword">len</span> <span class="sign">=</span> <a href="../low_level/public_variables_f90.html#robo71">etsf_io_low_error_len</a><span class="sign">)</span> <span class="sign">:</span><span class="sign">:</span> filename<span class="sign">,</span> error_string
  <span class="keyword">logical</span> <span class="sign">:</span><span class="sign">:</span> lstat
  <span class="keyword">type</span><span class="sign">(</span><a href="../low_level/public_variables_f90.html#robo68">etsf_io_low_error</a><span class="sign">)</span> <span class="sign">:</span><span class="sign">:</span> error_data
  <span class="keyword">integer</span> <span class="sign">:</span><span class="sign">:</span> i_atom
  <span class="keyword">double</span> <span class="keyword">precision</span> <span class="sign">:</span><span class="sign">:</span> coord<span class="sign">(</span>etsf_3dimlen<span class="sign">)</span>
</pre>
<p class="item_name">NOTES</p>
<p>  In this tutorial, we will open an ETSF file, and some variable of the
  geometry group (see the first tutorial on how to <a href="./create_a_crystal_den_file_f90.html#robo5">create_a_crystal_den_file</a>
  for further explanations on groups and especially <a href="../group_level/etsf_io_f90.html#robo12">etsf_geometry</a>).
</p>

<p>  The required data to create an XYZ file are:
</p>
<ul><li>  primitive_vectors for the box definition,
</li>
<li>  reduced_atom_positions for the atom coordinates,
</li>
<li>  atom_species for the nature of elements.
</li>
</ul>
<p></p>
<p class="item_name">SOURCE</p>
<pre class="source">  <span class="keyword">integer</span> <span class="sign">:</span><span class="sign">:</span> ncid
  <span class="keyword">type</span><span class="sign">(</span><a href="../group_level/etsf_io_f90.html#robo10">etsf_dims</a><span class="sign">)</span> <span class="sign">:</span><span class="sign">:</span> dims_data
  <span class="keyword">type</span><span class="sign">(</span><a href="../group_level/etsf_io_f90.html#robo12">etsf_geometry</a><span class="sign">)</span> <span class="sign">:</span><span class="sign">:</span> geometry_data
  <span class="keyword">double</span> <span class="keyword">precision</span><span class="sign">,</span> <span class="keyword">allocatable</span><span class="sign">,</span> target <span class="sign">:</span><span class="sign">:</span> primitive_vectors<span class="sign">(</span><span class="sign">:</span><span class="sign">,</span><span class="sign">:</span><span class="sign">)</span>
  <span class="keyword">double</span> <span class="keyword">precision</span><span class="sign">,</span> <span class="keyword">allocatable</span><span class="sign">,</span> target <span class="sign">:</span><span class="sign">:</span> reduced_atom_positions<span class="sign">(</span><span class="sign">:</span><span class="sign">,</span><span class="sign">:</span><span class="sign">)</span>
  <span class="keyword">integer</span><span class="sign">,</span> <span class="keyword">allocatable</span><span class="sign">,</span> target <span class="sign">:</span><span class="sign">:</span> atom_species<span class="sign">(</span><span class="sign">:</span><span class="sign">)</span>
</pre>
<p class="item_name">NOTES</p>
<p>  The names of atoms receives a special treatment since it can be found in several
  variables. The specifications are clear on preference and we will use the
  <a href="../utils/etsf_io_tools_f90.html#robo116">etsf_io_tools_get_atom_names</a>() routine to handle this preference and read
  the atom names.
</p>
<p class="item_name">SOURCE</p>
<pre class="source">  <span class="keyword">character</span><span class="sign">(</span><span class="keyword">len</span> <span class="sign">=</span> etsf_charlen<span class="sign">)</span><span class="sign">,</span> <span class="keyword">allocatable</span> <span class="sign">:</span><span class="sign">:</span> atom_names<span class="sign">(</span><span class="sign">:</span><span class="sign">)</span>
</pre>
<p class="item_name">NOTES</p>
<p>  We read the number of argument and get the input filename from the command line.
</p>
<p class="item_name">SOURCE</p>
<pre class="source">  <span class="comment">! Read number of program argument, should be one.</span>
  <span class="keyword">if</span> <span class="sign">(</span>iargc<span class="sign">(</span><span class="sign">)</span> <span class="sign">/</span><span class="sign">=</span> 1<span class="sign">)</span> <span class="keyword">then</span>
     <span class="keyword">write</span><span class="sign">(</span>0<span class="sign">,</span> <span class="sign">*</span><span class="sign">)</span> <span class="quote">"Error: one argument is required."</span>
     stop
  <span class="keyword">end</span> <span class="keyword">if</span>
  <span class="comment">! Read name of input file.</span>
  <span class="keyword">call</span> getarg<span class="sign">(</span>1<span class="sign">,</span> filename<span class="sign">)</span>
</pre>
<p class="item_name">NOTES</p>
<p>  Before doing anything else, we check that our file is a valid crystallographic
  file. To do it, we use the module <a href="../utils/etsf_io_file_f90.html#robo1">etsf_io_file</a> and its routine
  <a href="../utils/etsf_io_file_public_f90.html#robo41">etsf_io_file_check</a>(). This routine will open the given file and check that it
  machtes one or several requirements (see flags in <a href="../group_level/etsf_io_f90.html#robo120">ETSF_IO_VALIDITY_FLAGS</a>). Flags
  can be added to form a complex validation on several specifications.
</p>

<p>  If an error occurs, we transform the error data to a string and output it on
  the standard error.
</p>
<p class="item_name">SOURCE</p>
<pre class="source">  <span class="keyword">call</span> <a href="../utils/etsf_io_file_public_f90.html#robo41">etsf_io_file_check</a><span class="sign">(</span><span class="keyword">trim</span><span class="sign">(</span>filename<span class="sign">)</span><span class="sign">,</span> etsf_crystallographic_data<span class="sign">,</span> <span class="sign">&amp;</span>
       <span class="sign">&amp;</span> lstat<span class="sign">,</span> error_data<span class="sign">)</span>
  <span class="keyword">if</span> <span class="sign">(</span><span class="sign">.</span><span class="keyword">not</span><span class="sign">.</span> lstat<span class="sign">)</span> <span class="keyword">then</span>
     <span class="keyword">write</span><span class="sign">(</span>0<span class="sign">,</span> <span class="sign">*</span><span class="sign">)</span> <span class="quote">"Error: invalid input file, it does not match crystallographic"</span>
     <span class="keyword">write</span><span class="sign">(</span>0<span class="sign">,</span> <span class="sign">*</span><span class="sign">)</span> <span class="quote">"       requirements. Given reason:"</span>
     <span class="keyword">call</span> <a href="../low_level/etsf_io_low_level_f90.html#robo73">etsf_io_low_error_to_str</a><span class="sign">(</span>error_string<span class="sign">,</span> error_data<span class="sign">)</span>
     <span class="keyword">write</span><span class="sign">(</span>0<span class="sign">,</span> <span class="quote">"(A)"</span><span class="sign">)</span> <span class="keyword">trim</span><span class="sign">(</span>error_string<span class="sign">)</span>
     stop
  <span class="keyword">end</span> <span class="keyword">if</span>
</pre>
<p class="item_name">NOTES</p>
<p>  Now that our file is valid, we will follow a step by step procedure to
  reopen it, read the dimensions, allocate our temporary arrays, read the required
  informations, get the atoms names, close the file and output the informations
  in XYZ format.
</p>
<p class="item_name">SOURCE</p>
<pre class="source">  <span class="keyword">call</span> <a href="../low_level/read_routines_f90.html#robo80">etsf_io_low_open_read</a><span class="sign">(</span>ncid<span class="sign">,</span> <span class="keyword">trim</span><span class="sign">(</span>filename<span class="sign">)</span><span class="sign">,</span> lstat<span class="sign">,</span> error_data <span class="sign">=</span> error_data<span class="sign">)</span>
  <span class="keyword">if</span> <span class="sign">(</span><span class="sign">.</span><span class="keyword">not</span><span class="sign">.</span> lstat<span class="sign">)</span> <span class="keyword">then</span>
     <span class="keyword">call</span> <a href="../low_level/etsf_io_low_level_f90.html#robo73">etsf_io_low_error_to_str</a><span class="sign">(</span>error_string<span class="sign">,</span> error_data<span class="sign">)</span>
     <span class="keyword">write</span><span class="sign">(</span>0<span class="sign">,</span> <span class="quote">"(A)"</span><span class="sign">)</span> <span class="keyword">trim</span><span class="sign">(</span>error_string<span class="sign">)</span>
     stop
  <span class="keyword">end</span> <span class="keyword">if</span>
</pre>
<p class="item_name">NOTES</p>
<p>  The dimensions are read and stored into dims_data.
</p>
<p class="item_name">SOURCE</p>
<pre class="source">  <span class="keyword">call</span> <a href="../group_level/etsf_io_dims_get_f90.html#robo34">etsf_io_dims_get</a><span class="sign">(</span>ncid<span class="sign">,</span> dims_data<span class="sign">,</span> lstat<span class="sign">,</span> error_data<span class="sign">)</span>
  <span class="keyword">if</span> <span class="sign">(</span><span class="sign">.</span><span class="keyword">not</span><span class="sign">.</span> lstat<span class="sign">)</span> <span class="keyword">then</span>
     <span class="keyword">call</span> <a href="../low_level/etsf_io_low_level_f90.html#robo73">etsf_io_low_error_to_str</a><span class="sign">(</span>error_string<span class="sign">,</span> error_data<span class="sign">)</span>
     <span class="keyword">write</span><span class="sign">(</span>0<span class="sign">,</span> <span class="quote">"(A)"</span><span class="sign">)</span> <span class="keyword">trim</span><span class="sign">(</span>error_string<span class="sign">)</span>
     stop
  <span class="keyword">end</span> <span class="keyword">if</span>
</pre>
<p class="item_name">NOTES</p>
<p>  We allocate the local arrays where to put the read informations.
</p>
<p class="item_name">SOURCE</p>
<pre class="source">  <span class="keyword">allocate</span><span class="sign">(</span>primitive_vectors<span class="sign">(</span>dims_data<span class="sign">%</span>number_of_cartesian_directions<span class="sign">,</span> <span class="sign">&amp;</span>
       <span class="sign">&amp;</span> dims_data<span class="sign">%</span>number_of_vectors<span class="sign">)</span><span class="sign">)</span>
  <span class="keyword">allocate</span><span class="sign">(</span>reduced_atom_positions<span class="sign">(</span>dims_data<span class="sign">%</span>number_of_reduced_dimensions<span class="sign">,</span> <span class="sign">&amp;</span>
       <span class="sign">&amp;</span> dims_data<span class="sign">%</span>number_of_atoms<span class="sign">)</span><span class="sign">)</span>
  <span class="keyword">allocate</span><span class="sign">(</span>atom_species<span class="sign">(</span>dims_data<span class="sign">%</span>number_of_atoms<span class="sign">)</span><span class="sign">)</span>
  <span class="keyword">allocate</span><span class="sign">(</span>atom_names<span class="sign">(</span>dims_data<span class="sign">%</span>number_of_atom_species<span class="sign">)</span><span class="sign">)</span>
  geometry_data<span class="sign">%</span>primitive_vectors <span class="sign">=</span><span class="sign">&gt;</span> primitive_vectors
  geometry_data<span class="sign">%</span>reduced_atom_positions <span class="sign">=</span><span class="sign">&gt;</span> reduced_atom_positions
  geometry_data<span class="sign">%</span>atom_species <span class="sign">=</span><span class="sign">&gt;</span> atom_species
</pre>
<p class="item_name">NOTES</p>
<p>  We get the informations from the NetCDF file for the pointers that have been
  associated in geometry_data.
</p>
<p class="item_name">SOURCE</p>
<pre class="source">  <span class="keyword">call</span> <a href="../group_level/etsf_io_geometry_get_f90.html#robo50">etsf_io_geometry_get</a><span class="sign">(</span>ncid<span class="sign">,</span> geometry_data<span class="sign">,</span> lstat<span class="sign">,</span> error_data<span class="sign">)</span>
  <span class="keyword">if</span> <span class="sign">(</span><span class="sign">.</span><span class="keyword">not</span><span class="sign">.</span> lstat<span class="sign">)</span> <span class="keyword">then</span>
     <span class="keyword">call</span> <a href="../low_level/etsf_io_low_level_f90.html#robo73">etsf_io_low_error_to_str</a><span class="sign">(</span>error_string<span class="sign">,</span> error_data<span class="sign">)</span>
     <span class="keyword">write</span><span class="sign">(</span>0<span class="sign">,</span> <span class="quote">"(A)"</span><span class="sign">)</span> <span class="keyword">trim</span><span class="sign">(</span>error_string<span class="sign">)</span>
     stop
  <span class="keyword">end</span> <span class="keyword">if</span>
</pre>
<p class="item_name">NOTES</p>
<p>  We use the high level routine that get the names of atoms. If the file is valid,
  it always returns string informations (into @atom_names), but atomic numbers can
  also be returned as double values in an optional array (see @atom_numbers). We
  don't need here the double values, so we don't use the optional argument.
</p>
<p class="item_name">SOURCE</p>
<pre class="source">  <span class="keyword">call</span> <a href="../utils/etsf_io_tools_f90.html#robo116">etsf_io_tools_get_atom_names</a><span class="sign">(</span>ncid<span class="sign">,</span> atom_names<span class="sign">,</span> lstat<span class="sign">,</span> error_data<span class="sign">)</span>
  <span class="keyword">if</span> <span class="sign">(</span><span class="sign">.</span><span class="keyword">not</span><span class="sign">.</span> lstat<span class="sign">)</span> <span class="keyword">then</span>
     <span class="keyword">call</span> <a href="../low_level/etsf_io_low_level_f90.html#robo73">etsf_io_low_error_to_str</a><span class="sign">(</span>error_string<span class="sign">,</span> error_data<span class="sign">)</span>
     <span class="keyword">write</span><span class="sign">(</span>0<span class="sign">,</span> <span class="quote">"(A)"</span><span class="sign">)</span> <span class="keyword">trim</span><span class="sign">(</span>error_string<span class="sign">)</span>
     stop
  <span class="keyword">end</span> <span class="keyword">if</span>
</pre>
<p class="item_name">NOTES</p>
<p>  We don't forget to close the file.
</p>
<p class="item_name">SOURCE</p>
<pre class="source">  <span class="keyword">call</span> <a href="../low_level/etsf_io_low_level_f90.html#robo64">etsf_io_low_close</a><span class="sign">(</span>ncid<span class="sign">,</span> lstat<span class="sign">,</span> error_data<span class="sign">)</span>
  <span class="keyword">if</span> <span class="sign">(</span><span class="sign">.</span><span class="keyword">not</span><span class="sign">.</span> lstat<span class="sign">)</span> <span class="keyword">then</span>
     <span class="keyword">call</span> <a href="../low_level/etsf_io_low_level_f90.html#robo73">etsf_io_low_error_to_str</a><span class="sign">(</span>error_string<span class="sign">,</span> error_data<span class="sign">)</span>
     <span class="keyword">write</span><span class="sign">(</span>0<span class="sign">,</span> <span class="quote">"(A)"</span><span class="sign">)</span> <span class="keyword">trim</span><span class="sign">(</span>error_string<span class="sign">)</span>
     stop
  <span class="keyword">end</span> <span class="keyword">if</span>
</pre>
<p class="item_name">NOTES</p>
<p>  Finally we output informations in XYZ format.
</p>
<p class="item_name">SOURCE</p>
<pre class="source">  <span class="keyword">write</span><span class="comment">(*, "(I0)") dims_data%number_of_atoms
  write(*, "(3A)") "Converted from '", trim(filename), "'"
  do i_atom = 1, dims_data%number_of_atoms, 1
     coord(1) = primitive_vectors(1, 1) * reduced_atom_positions(1, i_atom) + &amp;
          &amp; primitive_vectors(2, 1) * reduced_atom_positions(2, i_atom) + &amp;
          &amp; primitive_vectors(3, 1) * reduced_atom_positions(3, i_atom)
     coord(2) = primitive_vectors(1, 2) * reduced_atom_positions(1, i_atom) + &amp;
          &amp; primitive_vectors(2, 2) * reduced_atom_positions(2, i_atom) + &amp;
          &amp; primitive_vectors(3, 2) * reduced_atom_positions(3, i_atom)
     coord(3) = primitive_vectors(1, 3) * reduced_atom_positions(1, i_atom) + &amp;
          &amp; primitive_vectors(2, 3) * reduced_atom_positions(2, i_atom) + &amp;
          &amp; primitive_vectors(3, 3) * reduced_atom_positions(3, i_atom)
     write(*, "(A,3E16.6)") trim(atom_names(atom_species(i_atom))), coord
  end do

  deallocate(primitive_vectors)
  deallocate(reduced_atom_positions)
  deallocate(atom_species)
  deallocate(atom_names)
end program <strong>convert_to_xyz</strong>
</pre>

</div> <!-- content -->
<div id="footer">
<p>Generated from ./src/tutorials/convert_to_xyz.f90 with <a href="http://www.xs4all.nl/~rfsber/Robo/robodoc.html">ROBODoc</a> V4.99.30 on Mon Mar 29 2010 11:04:46
</p>
</div> <!-- footer -->
</body>
</html>
