!! NOTES
!!  This file has been automatically generated by the @SCRIPT@
!!  script. Any change you would bring to it will systematically be
!!  overwritten. See the template file in config/etsf/template.tests.

program tests_write

  use etsf_io_low_level
  use etsf_io
  
  implicit none

  call test_data_write()
@CALL_WRITE_GROUP@
  
contains

  subroutine tests_write_status(name, lstat, error)
    character(len = *), intent(in)      :: name
    logical, intent(in)                 :: lstat
    type(etsf_io_low_error), intent(in) :: error
    
    if (lstat) then
      write(*, "(A,A,A,A)") "== ", name, repeat(" ", 68 - len(name)), "OK     =="
    else
      write(*, "(A,A,A,A)") "== ", name, repeat(" ", 68 - len(name)), "Failed =="
      call etsf_io_low_error_handle(error)
    end if
  end subroutine tests_write_status

  subroutine test_write_var_unformatted(varname, main_id)
    character(len = *), intent(in) :: varname
    integer, intent(in) :: main_id
    
    type(etsf_main) :: main
    type(etsf_groups) :: grp
    type(etsf_io_low_var_infos) :: var_infos
    double precision, allocatable, target :: values(:)
    integer :: ncid, i, length
    logical :: lstat
    type(etsf_io_low_error) :: error_data
    
    call tests_write_status("variable '"// trim(varname) //"'", .true., error_data)
    call etsf_io_low_open_read(ncid, "test_"// trim(varname) //".nc", lstat, error_data = error_data)
    call tests_write_status(" | opening", lstat, error_data)
    call etsf_io_low_read_var_infos(ncid, trim(varname), var_infos, lstat, error_data = error_data)
    call tests_write_status(" | read '"// trim(varname) //"' characteristics", lstat, error_data)
    call etsf_io_low_close(ncid, lstat, error_data = error_data)
    call tests_write_status(" | closing", lstat, error_data)
    length = 1
    do i = 1, var_infos%ncshape, 1
      length = length * var_infos%ncdims(i)
    end do
    allocate(values(length))
    ! for testing purpose, every pointers are associated, don't do that in normal cases
@WRITE_MAIN_ASSOCIATE@
    values = (/ (i, i = 1, length) /)
    call etsf_io_data_write("test_"// trim(varname) //".nc", main_id, etsf_grp_none, &
                          & main, grp, lstat, error_data)
    call tests_write_status("write action", lstat, error_data)
    values(:) = 0.d0
    call etsf_io_low_open_read(ncid, "test_"// trim(varname) //".nc", lstat, error_data = error_data)
    call tests_write_status(" | opening", lstat, error_data)
    call etsf_io_low_read_var(ncid, trim(varname), values, lstat, error_data = error_data)
    call tests_write_status(" | reading values", lstat, error_data)
    lstat = .true.
    do i = 1, length, 1
      lstat = (int(values(i)) == i) .and. lstat
    end do
    if (.not. lstat) then
      call etsf_io_low_error_set(error_data, ERROR_MODE_SPEC, ERROR_TYPE_VAR, &
                               & "test_write_var_unformatted", tgtname = trim(varname), &
                               & errmess = "wrong characteristics")
    end if
    call tests_write_status(" | check '"// trim(varname) //"' values", lstat, error_data)
    call etsf_io_low_close(ncid, lstat, error_data = error_data)
    call tests_write_status(" | closing", lstat, error_data)
    deallocate(values)
  end subroutine test_write_var_unformatted
  
  subroutine test_data_write()
    type(etsf_main) :: main
    type(etsf_groups) :: grp
    integer :: ncid
    type(etsf_io_low_error) :: error
    type(etsf_io_low_var_double) :: var
    character(len = *), parameter :: me = "test_data_write"
    logical :: lstat

    write(*,*)
    write(*,*) "Testing etsf_io_data_write()..."

    call etsf_io_data_write("pouet", etsf_main_density, etsf_grp_none, &
                          & main, grp, lstat, error)
    call tests_write_status("filename: wrong value (no file)", (.not. lstat), error)
    call etsf_io_data_write("Makefile", etsf_main_density, etsf_grp_none, &
                          & main, grp, lstat, error)
    call tests_write_status("filename: wrong value (text file)", (.not. lstat), error)

    call etsf_io_data_write("test_density.nc", -1, etsf_grp_none, &
                          & main, grp, lstat, error)
    call tests_write_status("main_var: wrong value", (.not. lstat), error)

    call etsf_io_data_write("test_density.nc", etsf_main_density, -1, &
                          & main, grp, lstat, error)
    call tests_write_status("groups: wrong value", (.not. lstat), error)

@WRITE_MAIN@

    write(*,*)

  end subroutine test_data_write

@WRITE_GRP@

end program tests_write
